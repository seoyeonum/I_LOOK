<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team1.mybatis.IChildDAO">

    <!-- [1] 아이 백업 등록 -->
    <insert id="addChildBackup" parameterType="com.team1.dto.ChildDTO">
        <selectKey keyProperty="child_backup_id" resultType="String" order="BEFORE">
            SELECT 'CBAC' || LPAD(CHILD_BACKUP_SEQ.NEXTVAL, 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO CHILD_BACKUP (CHILD_BACKUP_ID, PAR_BACKUP_ID, REG_DATE)
        VALUES (#{child_backup_id}, #{par_backup_id}, SYSDATE)
    </insert>

    <!-- [2] 아이 정보 등록 -->
    <insert id="add" parameterType="com.team1.dto.ChildDTO">
        <selectKey keyProperty="child_reg_id" resultType="String" order="BEFORE">
            SELECT 'CREG' || LPAD(CHILD_REG_SEQ.NEXTVAL, 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO CHILD_REG (
            CHILD_REG_ID, CHILD_BACKUP_ID, NAME, HEIGHT, WEIGHT,
            SSN_FIRST, SSN_SECOND, SPECIAL_NOTES, BLOOD_TYPE
        ) VALUES (
            #{child_reg_id}, #{child_backup_id}, #{name}, #{height}, #{weight},
            #{ssn_first}, #{ssn_second}, #{special_notes}, #{blood_type}
        )
    </insert>

    <!-- [3] 부모 백업 ID 조회 -->
    <select id="findParBackupId" parameterType="string" resultType="string">
        SELECT PAR_BACKUP_ID
        FROM PAR_BACKUP
        WHERE ID = #{id}
    </select>

    <!-- [4] 지병 등록 -->
    <insert id="addDisease" parameterType="com.team1.dto.ChildDTO">
        <selectKey keyProperty="child_medical_id" resultType="String" order="BEFORE">
            SELECT 'CMD' || LPAD(CHILD_MEDICAL_SEQ.NEXTVAL, 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO CHILD_MEDICALS (
            CHILD_MEDICAL_ID, MEDICAL_TYPE_ID, REG_DATE, CHILD_REG_ID
        ) VALUES (
            #{child_medical_id}, #{medical_type_id}, SYSDATE,
            (SELECT CHILD_REG_ID FROM CHILD_REG WHERE CHILD_BACKUP_ID = #{child_backup_id})
        )
    </insert>

    <!-- [5] 알레르기 등록 -->
    <insert id="addAllergy" parameterType="com.team1.dto.ChildDTO">
        <selectKey keyProperty="child_allergy_id" resultType="String" order="BEFORE">
            SELECT 'CAL' || LPAD(CHILD_ALLERGY_SEQ.NEXTVAL, 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO CHILD_ALLERGIES (
            CHILD_ALLERGY_ID, ALLERGIE_TYPE_ID, REG_DATE, CHILD_REG_ID
        ) VALUES (
            #{child_allergy_id}, #{allergy_type_id}, SYSDATE,
            (SELECT CHILD_REG_ID FROM CHILD_REG WHERE CHILD_BACKUP_ID = #{child_backup_id})
        )
    </insert>

    <!-- [6] 장애 등록 -->
    <insert id="addDisability" parameterType="com.team1.dto.ChildDTO">
        <selectKey keyProperty="child_disability_id" resultType="String" order="BEFORE">
            SELECT 'CDS' || LPAD(CHILD_DISABILITY_SEQ.NEXTVAL, 4, '0') FROM DUAL
        </selectKey>
        INSERT INTO CHILD_DISABILITIES (
            CHILD_DISABILITY_ID, DISABILITY_TYPE_ID, REG_DATE, CHILD_REG_ID
        ) VALUES (
            #{child_disability_id}, #{disability_type_id}, SYSDATE,
            (SELECT CHILD_REG_ID FROM CHILD_REG WHERE CHILD_BACKUP_ID = #{child_backup_id})
        )
    </insert>

    <!-- [7] 유형 목록 -->
    <select id="getDisabilityTypes" resultType="com.team1.dto.ChildDTO">
        SELECT DISABILITY_TYPE_ID, TYPE FROM DISABILITY_TYPES
    </select>

    <select id="getAllergyTypes" resultType="com.team1.dto.ChildDTO">
        SELECT ALLERGIE_TYPE_ID AS allergy_type_id, TYPE FROM ALLERGIE_TYPES
    </select>

    <select id="getMedicalTypes" resultType="com.team1.dto.ChildDTO">
        SELECT MEDICAL_TYPE_ID AS medical_type_id, TYPE FROM MEDICAL_TYPES
    </select>
   
   <!-- [8] 아이 이름 목록 -->
   <select id="listName" resultType="com.team1.dto.ChildDTO">
	    SELECT C.CHILD_BACKUP_ID, CR.NAME
	    FROM PAR_BACKUP P
	    JOIN CHILD_BACKUP C ON P.PAR_BACKUP_ID = C.PAR_BACKUP_ID
	    JOIN CHILD_REG CR ON C.CHILD_BACKUP_ID = CR.CHILD_BACKUP_ID
	    WHERE P.PAR_BACKUP_ID = #{parBackupId} 
   </select>
   
   <!-- [9] 아이 정보 수정 -->
   <update id="modifyByBackupId" parameterType="com.team1.dto.ChildDTO">
    UPDATE CHILD_REG
    SET HEIGHT = #{height},
        WEIGHT = #{weight},
        SPECIAL_NOTES = #{special_notes}
    WHERE CHILD_BACKUP_ID = #{child_backup_id}
	</update>

	<!-- [10] 단일 아이 리스트 -->
   <!-- 아이 백업 ID로 단일 아이 조회 -->
	<select id="findByBackupId" resultType="com.team1.dto.ChildDTO">
	    SELECT *
	    FROM CHILD_REG
	    WHERE CHILD_BACKUP_ID = #{child_backup_id}
	</select>
   

</mapper>